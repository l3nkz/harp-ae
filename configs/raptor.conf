# Define the generic functions to access energy sensors and time
function get_energy() {
    cat "/sys/devices/virtual/powercap/intel-rapl/intel-rapl:0/energy_uj"
}

function energy_diff() {
    local begin=$1
    local end=$2

    if [ "$end" == "" ]; then
        end=$(get_energy)
    fi

    if [[ $end -le $begin ]]; then
        max=$(cat "/sys/devices/virtual/powercap/intel-rapl/intel-rapl:0/max_energy_range_uj")
        echo "$((end + max - begin))"
    else
        echo "$((end - begin))"
    fi
}

function get_time() {
    echo "$(date +%s%3N)"
}

function time_diff() {
    local begin=$1
    local end=$2

    if [ "$end" == "" ]; then
        end=$(get_time)
    fi

    echo "$((end - begin))"
}

function bigs() {
    local bs=$1
    local bd=$2
    local res=""
    if [[ $bd -ge 1 ]]; then
        for b in $(seq 0 $((bd - 1))); do
            if [ "$res" == "" ]; then
                res="P${b}_0,P${b}_1"
            else
                res="$res,P${b}_0,P${b}_1"
            fi
        done
    fi
    if [[ $bs -ge 1 ]]; then
        for b in $(seq $bd $((bd + bs - 1))); do
            if [ "$res" == "" ]; then
                res="P${b}_0"
            else
                res="$res,P${b}_0"
            fi
        done
    fi

    echo "$res"
}

function littles() {
    local l=$1
    local res=""

    if [[ $l -ge 1 ]]; then
        for c in $(seq -f "%02g" 0 $((l -1))); do
            if [ "$res" == "" ]; then
                res="E$c"
            else
                res="$res,E$c"
            fi
        done
    fi

    echo "$res"
}

function construct_configs() {
    for bs in $(seq 0 8); do
        for bd in $(seq 0 8); do
            for l in $(seq 0 16); do
                if [[ $((bs + bd + l)) = 0 ]]; then
                    continue
                elif [[ $((bs + bd)) -gt 8 ]]; then
                    continue
                fi

                local big_cpus=$(bigs $bs $bd)
                local little_cpus=$(littles $l)

                if [ "$big_cpus" == "" ]; then
                    configs+=("$little_cpus")
                elif [ "$little_cpus" == "" ]; then
                    configs+=("$big_cpus")
                else
                    configs+=("${big_cpus},${little_cpus}")
                fi
            done
        done
    done
}

function setup_env_raptor() {
    # Set the scaling governor to performance and the frequencies such that thermal limits are not reached
    local sysfs_base=/sys/devices/system/cpu

    for c in $(seq 0 15); do
            echo powersave > $sysfs_base/cpu$c/cpufreq/scaling_governor
            echo 4600000 > $sysfs_base/cpu$c/cpufreq/scaling_max_freq
    done
    for c in $(seq 16 31); do
            echo powersave > $sysfs_base/cpu$c/cpufreq/scaling_governor
            echo 3800000 > $sysfs_base/cpu$c/cpufreq/scaling_max_freq
    done

    # Make the RAPL registers accessible to everyone
    chmod o+r /sys/devices/virtual/powercap/intel-rapl/intel-rapl:0/{energy_uj,max_energy_range_uj}

    echo 0
}
platform_routines["setup"]="setup_env_raptor"

function check_env_raptor() {
    # Check the proper scaling governor and frequencies
    local sysfs_base=/sys/devices/system/cpu

    failure=0
    for c in $(seq 0 15); do
        if [ $(cat $sysfs_base/cpu$c/cpufreq/scaling_governor) != "powersave" ]; then
            >&2 echo "Failed to set powersave governor on CPU $c"
            failure=1
        fi
        if [ $(cat $sysfs_base/cpu$c/cpufreq/scaling_max_freq) != "4600000" ]; then
            >&2 echo "Failed to set max frequency on CPU $c"
            failure=1
        fi
    done
    for c in $(seq 16 31); do
        if [ $(cat $sysfs_base/cpu$c/cpufreq/scaling_governor) != "powersave" ]; then
            >&2 echo "Failed to set powersave governor on CPU $c"
            failure=1
        fi
        if [ $(cat $sysfs_base/cpu$c/cpufreq/scaling_max_freq) != "3800000" ]; then
            >&2 echo "Failed to set max frequency on CPU $c"
            failure=1
        fi
    done

    echo $failure
}
platform_routines["check"]="check_env_raptor"

# Other configuration options of the platform
platform_name="raptor-lake-8P16E"
